angular.module("nab.ib.nabapi.authentication",["nab.ib.nabapi.config","corsIEFix"]).constant("jwTokenUrl","/nabib/authentication/getJwt.do").constant("apiTokenLocation","/init/auth?v=3").constant("maxAuthenticationRetryAttemptCount",2).config(["$provide","nabApiConfig","apiTokenLocation",function(c,b,a){c.constant("apiTokenUrl",b.domain+a)}]).config(["$provide","$httpProvider","nabApiConfig",function(c,b,a){c.factory("nabApiApplicationIdInterceptor",["nabApiConfig","nabApiUtilService",function(d,e){return{request:function(f){if(!e.isApiUrl(f.url)){return f}if(!f.headers["x-nab-key"]){f.headers["x-nab-key"]=d.applicationId}return f}}}]);c.factory("nabApiAuthenticationServiceInterceptor",["$q","$injector","maxAuthenticationRetryAttemptCount","nabApiConfig","nabApiUtilService",function(i,p,l,m,r){var h;var n;var o=0;var j=0;function g(){h=h||p.get("nabApiAuthenticationService");return h}function d(s){n=n||p.get("$http");return n(s)}function k(s){return function(t){s.headers.Authorization=t;return s}}function q(s){o=0;return s}function f(s){o=0;j=0}function e(s,u,t){f();return g().httpAuthenticationError(s,u,t,false)}return{request:function(s){if(!r.isApiUrl(s.url)){return s}if(r.isApiTokenUrl(s.url)){return s}return g().apiToken().then(q).then(k(s))},responseError:function(s){if(s.config===undefined){return i.reject(s)}if(!r.isApiUrl(s.config.url)||s.authentication){return i.reject(s)}if(s.status!==401){return i.reject(s)}if(r.isApiTokenUrl(s.config.url)){if(o>=l){var u="Authentication cycle detected. Attempted to reauthenticate "+o+" times before rejecting request.";return e(s,u,true)}o++}else{if(j>=l){var t="API call cycle detected. Attempted "+j+" times before rejecting request.";return e(s,t,false)}j++}g().clearTokens();return d(s.config)}}}]);c.factory("nabApiLegacyBrowserInterceptor",["nabApiConfig","nabApiUtilService","$q","corsUtil",function(d,g,e,f){return{request:function(h){if(!g.isApiUrl(h.url)){return h}if(f.isLegacyCorsRequest("POST",h.url)){f.toCorsRequest(h);h.data.cors.appId=d.applicationId;if(g.apiTokenCookie()){h.data.cors.authorization=g.apiTokenCookie()}}return h},response:function(h){if(g.isApiUrl(h.config.url)&&f.isLegacyCorsRequest("POST",h.config.url)&&h.data&&h.data.status&&h.data.status.code){h.status=parseInt(h.data.status.code.match(/[0-9]+/)[0],10);h.statusText=h.data.status.message;if(h.status>=400){return e.reject(h)}}return h||e.when(h)}}}]);if(a.enabledInterceptors===undefined||a.enabledInterceptors.nabApiApplicationIdInterceptor===undefined||a.enabledInterceptors.nabApiApplicationIdInterceptor){b.interceptors.push("nabApiApplicationIdInterceptor")}if(a.enabledInterceptors===undefined||a.enabledInterceptors.nabApiAuthenticationServiceInterceptor===undefined||a.enabledInterceptors.nabApiAuthenticationServiceInterceptor){b.interceptors.push("nabApiAuthenticationServiceInterceptor")}if(a.enabledInterceptors===undefined||a.enabledInterceptors.nabApiLegacyBrowserInterceptor===undefined||a.enabledInterceptors.nabApiLegacyBrowserInterceptor){b.interceptors.push("nabApiLegacyBrowserInterceptor")}}]).factory("nabApiUtilService",["$window","nabApiConfig","apiTokenUrl","$location",function(c,a,b,d){return{isApiUrl:function(e){return e.indexOf(a.domain)===0},isApiTokenUrl:function(e){return e.indexOf(b)===0},jwTokenCookie:function(e){if(arguments.length>0){throw new Error("JWT cannot be stored, is a one time use cookie.")}return $.cookie("nabibJwt")},apiTokenCookie:function(e){if(arguments.length>0){if(d.protocol()==="https"){$.cookie("nabibSessionToken",e,{secure:true})}else{$.cookie("nabibSessionToken",e)}}return $.cookie("nabibSessionToken")},clearTokenCookies:function(){$.removeCookie("nabibSessionToken");$.removeCookie("nabibJwt");$.removeCookie("nabibJwt",{path:"/nabib/mobile"})},getApplicationId:function(){return a.applicationId},isMobileIBUrl:function(){return location.pathname.indexOf("/nabib/mobile/")===0}}}]).factory("nabApiAuthenticationService",["$http","$q","$window","jwTokenUrl","apiTokenUrl","nabApiUtilService",function(h,c,a,d,e,k){var j;function b(){return h({method:"GET",url:d,cache:false})}function i(l){if(l.data.length>1024){return j.httpAuthenticationError(l,"JWT is too long (> 1024 bytes)",false,true)}return l.data}function g(l){var m={loginRequest:{brand:"nab",lob:"nab",credentials:{apiStructType:"token",token:{token:l}}}};return h.post(e,m)}function f(l){var m=l.data;if(m===undefined){return j.httpAuthenticationError(l,"Could not retrieve API Token from response: No data in response")}if(m.status===undefined){return j.httpAuthenticationError(l,"Could not retrieve API Token from response: No status in response")}if(m.status.code!=="API-200"){return j.httpAuthenticationError(l,"Could not retrieve API Token from response: No success status in response. Was '"+m.status.code+"'")}if(m.tokens===undefined){return j.httpAuthenticationError(l,"Could not retrieve API Token from response: No tokens available in response")}var n=$.grep(l.data.tokens,function(o){return(o.name==="Authorization"&&o.type==="header")});if(n.length>0){return n[0].value}else{return j.httpAuthenticationError(l,"Could not retrieve API Token from response: Authorisation header missing")}}j={jwToken:function(){var l=k.jwTokenCookie();if(l){this.clearTokens();return c.when(l)}else{return b().then(i,j.getJwtError)}},apiToken:function(){var m=k.jwTokenCookie();var l=k.apiTokenCookie();var n;if(m){this.clearTokens();n=c.when(m)}else{if(l){return c.when(l)}else{n=j.jwToken()}}return n.then(g,j.httpAuthenticationError).then(f,j.httpAuthenticationError).then(k.apiTokenCookie)},httpAuthenticationError:function(n,q,p,l){var o=q?q:"A server error was encountered";var m=p===undefined?true:p;var r=l===undefined?false:l;if(n.data&&n.data.constructor==Object){n.data.message=n.data.message===undefined?o:n.data.message;n.data.authentication=n.data.authentication===undefined?m:n.data.authentication;n.data.getJwt=n.data.getJwt===undefined?r:n.data.getJwt}else{n.data={content:n.data,message:o,authentication:m,getJwt:r}}return c.reject(n)},getJwtError:function(l,m){if(l.status==401){a.location.href=k.isMobileIBUrl()?"/nabib/mobile/login.ctl":"/nabib/login.ctl";l.data={message:"getJwt.do failed with 401, most likely IB session has expired.",authentication:false,getJwt:true};return c.reject(l)}else{return j.httpAuthenticationError(l,m,false,true)}},clearTokens:function(){k.clearTokenCookies()}};return j}]);